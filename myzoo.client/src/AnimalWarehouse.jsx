import { useState, useEffect, useContext } from "react";
import { useNavigate } from "react-router-dom";
import { Container, Grid, Card, CardMedia, CardContent, CardActions, Typography, Button, Box, TextField, Snackbar, Alert,
    Dialog, DialogTitle, DialogContent, DialogActions, Tooltip
} from "@mui/material";
import PaginationControls from "./PaginationControls";
import { UserContext } from "./UserContext";

const AnimalWarehouse = () => {
    const [animals, setAnimals] = useState([]);
    const [filteredAnimals, setFilteredAnimals] = useState([]);
    const [searchTerm, setSearchTerm] = useState("");
    const { setUserData } = useContext(UserContext);
    const [snackbarOpen, setSnackbarOpen] = useState(false);
    const [snackbarMessage, setSnackbarMessage] = useState("");
    const [showModal, setShowModal] = useState(false);
    const [selectedAnimalId, setSelectedAnimalId] = useState(null);
    const navigate = useNavigate();

    const [currentPage, setCurrentPage] = useState(1);
    const animalsPerPage = 30;

    const lastAnimal = currentPage * animalsPerPage;
    const firstAnimal = lastAnimal - animalsPerPage;
    const currentAnimals = filteredAnimals.slice(firstAnimal, lastAnimal);
    const totalPages = Math.ceil(filteredAnimals.length / animalsPerPage);

    useEffect(() => {
        fetch("https://localhost:7174/api/zoo/warehouse-animals", {
            method: "GET",
            credentials: "include",
        })
            .then((response) => response.json())
            .then(data => {
                setAnimals(data.animals || []);
            })
            .catch(error => console.error("An error occurred: ", error));
    }, []);

    useEffect(() => {
        const filtered = animals.filter((animal) =>
            animal.animalSpecies?.species.toLowerCase().includes(searchTerm.toLowerCase())
        );
        setFilteredAnimals(filtered);
        setCurrentPage(1);
    }, [searchTerm, animals]);


    const sellAnimal = (id) => {
        fetch("https://localhost:7174/api/buy/remove-from-warehouse", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(id),
            credentials: "include"
        })
            .then((response) => {
                return response.json().then((result) => {
                    if (response.ok) {
                        showSnackbar(result.message);
                        setAnimals((prev) => prev.filter((a) => a.warehouseAnimalId !== id));
                        setUserData(prev => ({
                            ...prev,
                            capital: result.newCapital
                        }));
                    } else {
                        showSnackbar(result.message || "An error occurred!");
                    }
                });
            })
            .catch((error) => {
                console.error("Network error:", error);
                showSnackbar("The animal could not be removed.");
            });
    };

    const moveToZoo = (id) => {
        fetch("https://localhost:7174/api/buy/add-to-zoo", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(id),
            credentials: "include"
        })
            .then((response) => {
                return response.json().then((result) => {
                    if (response.ok) {
                        showSnackbar(result.message);
                        setAnimals((prev) => prev.filter((a) => a.warehouseAnimalId !== id));
                    } else {
                        showSnackbar(result.message);
                    }
                });
            })
            .catch((error) => {
                console.error("An error occurred while moving:", error);
                showSnackbar("The animal could not be moved!");
            });
    };

    const handleNavigate = (animalId) => {
        navigate(`/animal-data/${animalId}`);
    };

    const showSnackbar = (message) => {
        setSnackbarMessage(message);
        setSnackbarOpen(true);
    };

    return (
        <>
            <Container sx={{ paddingY: 4 }}>
                <Typography variant="h2" fontWeight="bold" mb={3} sx={{ color: "#102e1d" }}>
                    Animal warehouse
                </Typography>

                <Box sx={{ mb: 3 }}>
                    <TextField fullWidth label="Search by Animal Name" variant="outlined" value={searchTerm} sx={{ backgroundColor: "mediumseagreen" }}
                        onChange={(e) => setSearchTerm(e.target.value)}/>
                </Box>

                <Grid container spacing={3} justifyContent="center">
                    {currentAnimals.map((animal) => (
                        <Grid item xs={12} small={6} medium={4} key={animal.warehouseAnimalId}>
                            <Card sx={{ height: "100%", display: "flex", flexDirection: "column", backgroundColor: "mediumseagreen", color: "white" }}>
                                <Tooltip title="Click to see more">
                                    <CardMedia component="img" height="300" image={animal.image} alt={animal.animalSpecies?.species}
                                        sx={{ objectFit: "cover", cursor: "pointer" }} onClick={() => handleNavigate(animal.animalId)}/>
                                </Tooltip>
                                <CardContent>
                                    <Typography variant="h6">
                                        {animal.animalSpecies?.species}
                                    </Typography>
                                    <Typography variant="body2" color="text.secondary">
                                        Sex: {animal.gender === 0 ? "Female" : animal.gender === 1 ? "Male" : "Baby"}
                                    </Typography>
                                    <Typography variant="body2" color="text.secondary">
                                        Value: {animal.value / 10}
                                    </Typography>
                                </CardContent>
                                <CardActions sx={{ display: "flex", flexDirection: "column" }}>
                                    <Button variant="contained" fullWidth sx={{ backgroundColor: "#297a4d", mb: 1 }}
                                        onClick={() => moveToZoo(animal.warehouseAnimalId)}>
                                        Add to zoo
                                    </Button>
                                    <Button variant="outlined" fullWidth sx={{ color: "white", borderColor: "white" }}
                                        onClick={() => { setSelectedAnimalId(animal.warehouseAnimalId); setShowModal(true); }}>
                                        Sell
                                    </Button>
                                </CardActions>
                            </Card>
                        </Grid>
                    ))}
                </Grid>

                <PaginationControls currentPage={currentPage} totalPages={totalPages} onPageChange={setCurrentPage} />
            </Container>

            <Snackbar open={snackbarOpen} autoHideDuration={3000} onClose={() => setSnackbarOpen(false)}
                anchorOrigin={{ vertical: "top", horizontal: "center" }}>
                <Alert onClose={() => setSnackbarOpen(false)} sx={{ width: "100%" }}>
                    {snackbarMessage}
                </Alert>
            </Snackbar>

            <Dialog open={showModal} onClose={() => setShowModal(false)}>
                <Box sx={{ backgroundColor: "mediumseagreen", color: "white" }}>
                    <DialogTitle>Are you sure you want to sell this animal?</DialogTitle>
                    <DialogContent>
                        This action cannot be undone and the animal will disappear from the warehouse permanently.
                    </DialogContent>
                    <DialogActions>
                        <Button variant="outlined" sx={{ color: "white", borderColor: "white" }} onClick={() => setShowModal(false)} >
                            Cancel
                        </Button>
                        <Button variant="contained" sx={{ backgroundColor: "#297a4d" }}
                            onClick={() => { sellAnimal(selectedAnimalId); setShowModal(false); }}>
                            Sell
                        </Button>
                    </DialogActions>
                </Box>
            </Dialog>
        </>
    );
};

export default AnimalWarehouse;